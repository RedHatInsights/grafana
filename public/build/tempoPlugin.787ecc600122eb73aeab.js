"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4156],{"./public/app/core/components/NodeGraphSettings.tsx":(e,a,t)=>{t.d(a,{n:()=>l});t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js");var s,n=t("./.yarn/__virtual__/@emotion-css-virtual-9fd25d72e0/0/cache/@emotion-css-npm-11.1.3-72aa05c30f-dc50283f65.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),i=t("./packages/grafana-data/src/index.ts"),r=t("./packages/grafana-ui/src/index.ts"),o=t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");function l({options:e,onOptionsChange:a}){var t;const n=(0,r.useStyles)(c);return(0,o.jsxs)("div",{className:n.container,children:[s||(s=(0,o.jsx)("h3",{className:"page-heading",children:"Node Graph"})),(0,o.jsx)(r.InlineFieldRow,{className:n.row,children:(0,o.jsx)(r.InlineField,{tooltip:"Enables the Node Graph visualization in the trace viewer.",label:"Enable Node Graph",labelWidth:26,children:(0,o.jsx)(r.InlineSwitch,{value:null===(t=e.jsonData.nodeGraph)||void 0===t?void 0:t.enabled,onChange:t=>(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"nodeGraph",Object.assign({},e.jsonData.nodeGraph,{enabled:t.currentTarget.checked}))})})})]})}const c=e=>({container:n.css`
    label: container;
    width: 100%;
  `,row:n.css`
    label: row;
    align-items: baseline;
  `})},"./public/app/core/components/TraceToLogsSettings.tsx":(e,a,t)=>{t.d(a,{Z:()=>c});var s,n=t("./.yarn/__virtual__/@emotion-css-virtual-9fd25d72e0/0/cache/@emotion-css-npm-11.1.3-72aa05c30f-dc50283f65.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),i=t("./packages/grafana-data/src/index.ts"),r=t("./packages/grafana-runtime/src/index.ts"),o=t("./packages/grafana-ui/src/index.ts"),l=(t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js"));function c({options:e,onOptionsChange:a}){var t,c,u,p,h,g,m;const v=(0,o.useStyles)(d);return(0,l.jsxs)("div",{className:(0,n.css)({width:"100%"}),children:[s||(s=(0,l.jsx)("h3",{className:"page-heading",children:"Trace to logs"})),(0,l.jsx)("div",{className:v.infoText,children:"Trace to logs let's you navigate from a trace span to the selected data source's log."}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{tooltip:"The data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:(0,l.jsx)(r.DataSourcePicker,{pluginId:"loki",current:null===(t=e.jsonData.tracesToLogs)||void 0===t?void 0:t.datasourceUid,noDefault:!0,width:40,onChange:t=>{var s;return(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",{datasourceUid:t.uid,tags:null===(s=e.jsonData.tracesToLogs)||void 0===s?void 0:s.tags})}})})}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{tooltip:"Tags that will be used in the Loki query. Default tags: 'cluster', 'hostname', 'namespace', 'pod'",label:"Tags",labelWidth:26,children:(0,l.jsx)(o.TagsInput,{tags:null===(c=e.jsonData.tracesToLogs)||void 0===c?void 0:c.tags,width:40,onChange:t=>{var s;return(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",{datasourceUid:null===(s=e.jsonData.tracesToLogs)||void 0===s?void 0:s.datasourceUid,tags:t})}})})}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{label:"Span start time shift",labelWidth:26,grow:!0,tooltip:"Shifts the start time of the span. Default 0 (Time units can be used here, for example: 5s, 1m, 3h)",children:(0,l.jsx)(o.Input,{type:"text",placeholder:"1h",width:40,onChange:t=>(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",Object.assign({},e.jsonData.tracesToLogs,{spanStartTimeShift:t.currentTarget.value})),value:(null===(u=e.jsonData.tracesToLogs)||void 0===u?void 0:u.spanStartTimeShift)||""})})}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{label:"Span end time shift",labelWidth:26,grow:!0,tooltip:"Shifts the end time of the span. Default 0 Time units can be used here, for example: 5s, 1m, 3h",children:(0,l.jsx)(o.Input,{type:"text",placeholder:"1h",width:40,onChange:t=>(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",Object.assign({},e.jsonData.tracesToLogs,{spanEndTimeShift:t.currentTarget.value})),value:(null===(p=e.jsonData.tracesToLogs)||void 0===p?void 0:p.spanEndTimeShift)||""})})}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{label:"Filter by Trace ID",labelWidth:26,grow:!0,tooltip:"Filters logs by Trace ID. Appends '|=<trace id>' to the query.",children:(0,l.jsx)(o.InlineSwitch,{value:null===(h=e.jsonData.tracesToLogs)||void 0===h?void 0:h.filterByTraceID,onChange:t=>(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",Object.assign({},e.jsonData.tracesToLogs,{filterByTraceID:t.currentTarget.checked}))})})}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{label:"Filter by Span ID",labelWidth:26,grow:!0,tooltip:"Filters logs by Span ID. Appends '|=<span id>' to the query.",children:(0,l.jsx)(o.InlineSwitch,{value:null===(g=e.jsonData.tracesToLogs)||void 0===g?void 0:g.filterBySpanID,onChange:t=>(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",Object.assign({},e.jsonData.tracesToLogs,{filterBySpanID:t.currentTarget.checked}))})})}),(0,l.jsx)(o.InlineFieldRow,{children:(0,l.jsx)(o.InlineField,{label:"Loki Search",labelWidth:26,grow:!0,tooltip:"Use this logs data source to search for traces.",children:(0,l.jsx)(o.InlineSwitch,{defaultChecked:!0,value:null===(m=e.jsonData.tracesToLogs)||void 0===m?void 0:m.lokiSearch,onChange:t=>(0,i.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"tracesToLogs",Object.assign({},e.jsonData.tracesToLogs,{lokiSearch:t.currentTarget.checked}))})})})]})}const d=e=>({infoText:n.css`
    padding-bottom: ${e.spacing.md};
    color: ${e.colors.textSemiWeak};
  `})},"./public/app/core/utils/tracing.ts":(e,a,t)=>{t.d(a,{et:()=>n,nO:()=>i,fy:()=>r,np:()=>l});var s=t("./packages/grafana-data/src/index.ts");function n(e){e.sort(((e,a)=>e[0]-a[0]));return e.reduce(((e,a)=>{if(!e.length)return[a];const t=e.slice(-1)[0],[s,n]=t,[i,r]=a;return r<n?e:i>n?[...e,a]:[...e.slice(0,-1),[s,r]]}),[]).reduce(((e,a)=>e+(a[1]-a[0])),0)}function i(e){const a={};let t;for(let s=0;t=e(s),t;s++){a[t.id]?a[t.id].span=t.span:a[t.id]={span:t.span,children:[]};for(const e of t.parentIds)e&&(a[e]?a[e].children.push(t.id):a[e]={span:void 0,children:[t.id]})}return a}function r(e,a,t){return{main:`${o(e)}ms (${o(e/a*100)}%)`,secondary:`${o(t)}ms (${o(t/e*100)}%)`}}function o(e){return parseFloat(e.toFixed(2))}function l(){return[new s.MutableDataFrame({fields:[{name:s.NodeGraphDataFrameFieldNames.id,type:s.FieldType.string},{name:s.NodeGraphDataFrameFieldNames.title,type:s.FieldType.string},{name:s.NodeGraphDataFrameFieldNames.subTitle,type:s.FieldType.string},{name:s.NodeGraphDataFrameFieldNames.mainStat,type:s.FieldType.string,config:{displayName:"Total time (% of trace)"}},{name:s.NodeGraphDataFrameFieldNames.secondaryStat,type:s.FieldType.string,config:{displayName:"Self time (% of total)"}},{name:s.NodeGraphDataFrameFieldNames.color,type:s.FieldType.number,config:{color:{mode:"continuous-GrYlRd"},displayName:"Self time / Trace duration"}}],meta:{preferredVisualisationType:"nodeGraph"}}),new s.MutableDataFrame({fields:[{name:s.NodeGraphDataFrameFieldNames.id,type:s.FieldType.string},{name:s.NodeGraphDataFrameFieldNames.target,type:s.FieldType.string},{name:s.NodeGraphDataFrameFieldNames.source,type:s.FieldType.string}],meta:{preferredVisualisationType:"nodeGraph"}})]}},"./public/app/plugins/datasource/tempo/module.ts":(e,a,t)=>{t.r(a),t.d(a,{plugin:()=>oe});var s,n=t("./packages/grafana-data/src/index.ts"),i=t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),r=t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");var o,l=t("./packages/grafana-ui/src/index.ts"),c=t("./public/app/core/components/TraceToLogsSettings.tsx"),d=t("./.yarn/__virtual__/@emotion-css-virtual-9fd25d72e0/0/cache/@emotion-css-npm-11.1.3-72aa05c30f-dc50283f65.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),u=t("./packages/grafana-runtime/src/index.ts");function p({options:e,onOptionsChange:a}){var t;const s=(0,l.useStyles)(h);return(0,r.jsxs)("div",{className:(0,d.css)({width:"100%"}),children:[o||(o=(0,r.jsx)("h3",{className:"page-heading",children:"Service Graph"})),(0,r.jsx)("div",{className:s.infoText,children:"To allow querying service graph data you have to select a Prometheus instance where the data is stored."}),(0,r.jsxs)(l.InlineFieldRow,{className:s.row,children:[(0,r.jsx)(l.InlineField,{tooltip:"The Prometheus data source with the service graph data",label:"Data source",labelWidth:26,children:(0,r.jsx)(u.DataSourcePicker,{pluginId:"prometheus",current:null===(t=e.jsonData.serviceMap)||void 0===t?void 0:t.datasourceUid,noDefault:!0,width:40,onChange:t=>(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"serviceMap",{datasourceUid:t.uid})})}),(0,r.jsx)(l.Button,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"serviceMap",{datasourceUid:void 0})},children:"Clear"})]})]})}const h=e=>({infoText:d.css`
    label: infoText;
    padding-bottom: ${e.spacing.md};
    color: ${e.colors.textSemiWeak};
  `,row:d.css`
    label: row;
    align-items: baseline;
  `});var g;function m({options:e,onOptionsChange:a}){var t;const s=(0,l.useStyles)(v);return(0,r.jsxs)("div",{className:s.container,children:[g||(g=(0,r.jsx)("h3",{className:"page-heading",children:"Search"})),(0,r.jsx)(l.InlineFieldRow,{className:s.row,children:(0,r.jsx)(l.InlineField,{tooltip:"Removes the Search tab from the Tempo query editor.",label:"Hide search",labelWidth:26,children:(0,r.jsx)(l.InlineSwitch,{value:null===(t=e.jsonData.search)||void 0===t?void 0:t.hide,onChange:t=>(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:a,options:e},"search",Object.assign({},e.jsonData.search,{hide:t.currentTarget.checked}))})})})]})}const v=e=>({container:d.css`
    label: container;
    width: 100%;
  `,row:d.css`
    label: row;
    align-items: baseline;
  `});var f=t("./public/app/core/components/NodeGraphSettings.tsx");var y=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/from.js"),j=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),b=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),x=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/merge.js"),D=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),T=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),w=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),S=t("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/toArray.js"),O=t("./public/app/core/utils/fetch.ts"),F=t("./public/app/features/plugins/datasource_srv.ts"),I=t("./.yarn/cache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),k=t("./public/app/plugins/datasource/tempo/graphTransform.ts"),N=t("./public/app/plugins/datasource/tempo/resultTransformer.ts");function C(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class _ extends u.DataSourceWithBackend{constructor(e){super(e),C(this,"tracesToLogs",void 0),C(this,"serviceMap",void 0),C(this,"search",void 0),C(this,"nodeGraph",void 0),C(this,"uploadedJson",null),this.instanceSettings=e,this.instanceSettings=e,this.tracesToLogs=e.jsonData.tracesToLogs,this.serviceMap=e.jsonData.serviceMap,this.search=e.jsonData.search,this.nodeGraph=e.jsonData.nodeGraph}query(e){var a,t,s,i,r,o,l;const c=[],d=e.targets.filter((e=>!e.hide)),u=(0,I.groupBy)(d,(e=>e.queryType||"traceId"));if(null!==(a=this.tracesToLogs)&&void 0!==a&&a.datasourceUid&&(null===(t=u.search)||void 0===t?void 0:t.length)>0){const a=(0,F.ak)();c.push((0,y.Dp)(a.get(this.tracesToLogs.datasourceUid)).pipe((0,D.z)((a=>{var t;const s=Object.assign({},e,{targets:u.search.map((e=>e.linkedQuery))}),n=(null===(t=a.instanceSettings.jsonData.derivedFields)||void 0===t?void 0:t.filter((e=>e.datasourceUid===this.uid&&e.matcherRegex)).map((e=>e.matcherRegex)))||[];return n&&0!==n.length?a.query(s).pipe((0,T.U)((e=>e.error?e:(0,N.RY)(e,this.uid,this.name,n)))):(0,j._)((()=>new Error("No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.")))}))))}if(null!==(s=u.nativeSearch)&&void 0!==s&&s.length)try{const e=this.buildSearchQuery(u.nativeSearch[0]);c.push(this._request("/api/search",e).pipe((0,T.U)((e=>({data:[(0,N.n4)(e.data.traces,this.instanceSettings)]}))),(0,w.K)((e=>(0,b.of)({error:{message:e.data.message},data:[]})))))}catch(e){return(0,b.of)({error:{message:e.message},data:[]})}if(null!==(i=u.upload)&&void 0!==i&&i.length)if(this.uploadedJson){const e=JSON.parse(this.uploadedJson);var p;if(e.batches)c.push((0,b.of)((0,N.IM)(e.batches,null===(p=this.nodeGraph)||void 0===p?void 0:p.enabled)));else c.push((0,b.of)({error:{message:"JSON is not valid OpenTelemetry format"},data:[]}))}else c.push((0,b.of)({data:[],state:n.LoadingState.Done}));var h,g;if(null!==(r=this.serviceMap)&&void 0!==r&&r.datasourceUid&&(null===(o=u.serviceMap)||void 0===o?void 0:o.length)>0&&c.push((h=e,g=this.serviceMap.datasourceUid,function(e,a){return(0,y.Dp)((0,F.ak)().get(a)).pipe((0,D.z)((a=>a.query(e))))}(function(e){return Object.assign({},e,{targets:k.t3.map((a=>({refId:a,expr:`delta(${a}${e.targets[0].serviceMapQuery||""}[$__range])`,instant:!0})))})}(h),g).pipe((0,S.q)(),(0,T.U)((e=>{const a=e.find((e=>!!e.error));if(a)throw new Error(a.error.message);const{nodes:t,edges:s}=(0,k.BC)(e,h.range);return t.fields[0].config={links:[q("Total requests",k.Yt,g),q("Failed requests",k.yf,g)]},{data:[t,s],state:n.LoadingState.Done}}))))),(null===(l=u.traceId)||void 0===l?void 0:l.length)>0){const a=Object.assign({},e,{targets:u.traceId});c.push(super.query(a).pipe((0,T.U)((e=>{var a;return e.error?e:(0,N.Jk)(e,null===(a=this.nodeGraph)||void 0===a?void 0:a.enabled)}))))}return(0,x.T)(...c)}async metadataRequest(e,a={}){return await this._request(e,a,{method:"GET",hideFromInspector:!0}).toPromise()}_request(e,a,t){const s=a?(0,O.tW)(a):"",n=`${this.instanceSettings.url}${e}${s.length?`?${s}`:""}`,i=Object.assign({},t,{url:n});return(0,u.getBackendSrv)().fetch(i)}async testDatasource(){const e={headers:{},method:"GET",url:`${this.instanceSettings.url}/api/echo`},a=await(0,u.getBackendSrv)().fetch(e).toPromise();if(null!=a&&a.ok)return{status:"success",message:"Data source is working"}}getQueryDisplayText(e){if("nativeSearch"===e.queryType){let a=[];for(const t of["serviceName","spanName","search","minDuration","maxDuration","limit"])e.hasOwnProperty(t)&&e[t]&&a.push(`${(0,I.startCase)(t)}: ${e[t]}`);return a.join(", ")}return e.query}buildSearchQuery(e){var a;let t=null!==(a=e.search)&&void 0!==a?a:"",s=(0,I.pick)(e,["minDuration","maxDuration","limit"]);if(s=(0,I.pickBy)(s,I.identity),e.serviceName&&(t+=` service.name="${e.serviceName}"`),e.spanName&&(t+=` name="${e.spanName}"`),s.limit||(s.limit=20),s.minDuration){if(!(0,n.isValidGoDuration)(s.minDuration))throw new Error("Please enter a valid min duration.");s.minDuration=s.minDuration.replace(/\s/g,"")}if(s.maxDuration){if(!(0,n.isValidGoDuration)(s.maxDuration))throw new Error("Please enter a valid max duration.");s.maxDuration=s.maxDuration.replace(/\s/g,"")}if(!Number.isInteger(s.limit)||s.limit<=0)throw new Error("Please enter a valid limit.");return Object.assign({tags:t},s)}async getServiceGraphLabels(){return(await(0,F.ak)().get(this.serviceMap.datasourceUid)).getTagKeys()}async getServiceGraphLabelValues(e){return(await(0,F.ak)().get(this.serviceMap.datasourceUid)).getTagValues({key:e})}}function q(e,a,t){return{url:"",title:e,internal:{query:{expr:a},datasourceUid:t,datasourceName:"Prometheus"}}}var L=t("./public/app/plugins/datasource/loki/components/LokiQueryField.tsx"),R=t("./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/lib/useAsync.js");var P=t("./.yarn/cache/prismjs-npm-1.25.0-8d60169ac0-04d8eae9d1.zip/node_modules/prismjs/prism.js"),G=t.n(P);function M(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class Q extends n.LanguageProvider{constructor(e,a){super(),M(this,"datasource",void 0),M(this,"tags",void 0),M(this,"request",(async(e,a={})=>{const t=await this.datasource.metadataRequest(e,a);return null==t?void 0:t.data})),M(this,"start",(async()=>(await this.fetchTags(),[]))),M(this,"provideCompletionItems",(async({prefix:e,text:a,value:t,labelKey:s,wrapperClasses:n},i={history:[]})=>{if(!t)return{suggestions:[]};const r=t.endText.getText();return"="===r[r.indexOf(a)-1]||"="===a?this.getTagValueCompletionItems(t):this.getTagsCompletionItems()})),M(this,"getTagsCompletionItems",(()=>{const{tags:e}=this,a=[];return null!=e&&e.length&&a.push({label:"Tag",items:e.map((e=>({label:e})))}),{suggestions:a}})),this.datasource=e,Object.assign(this,a)}async fetchTags(){const e=await this.request("/api/search/tags",[]);this.tags=e.tagNames}async getTagValueCompletionItems(e){var a;const t=e.endText.getText().split(" ");let s=null!==(a=t[t.length-1])&&void 0!==a?a:"";s=s.split("=")[0];const n=await this.request(`/api/search/tag/${s}/values`,[]),i=[];return n&&n.tagValues&&i.push({label:"Tag Values",items:n.tagValues.map((e=>({label:e})))}),{suggestions:i}}async getOptions(e){const a=await this.request(`/api/search/tag/${e}/values`);let t=[];return a&&a.tagValues&&(t=a.tagValues.map((e=>({value:e,label:e})))),t}}var U=t("./public/app/store/store.ts"),z=t("./public/app/core/actions/index.ts"),$=t("./public/app/core/copy/appNotification.ts");const W="tempo",B="e.g. 1.2s, 100ms",E=[(0,l.BracesPlugin)(),(0,l.SlatePrism)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:()=>W})];G().languages.tempo={key:{pattern:/[^\s]+(?==)/,alias:"attr-name"},operator:/[=]/,value:[{pattern:/"(.+)"/},{pattern:/[^\s]+/}]};const J=({datasource:e,query:a,onChange:t,onBlur:s,onRunQuery:o})=>{const c=(0,l.useStyles2)(V),d=(0,i.useMemo)((()=>new Q(e)),[e]),[u,p]=(0,i.useState)(!1),[h,g]=(0,i.useState)({serviceNameOptions:[],spanNameOptions:[]}),[m,v]=(0,i.useState)(null),[f,y]=(0,i.useState)({}),j=(0,i.useMemo)((()=>(0,I.debounce)((async()=>{const e=await d.getOptions("service.name");g((a=>Object.assign({},a,{serviceNameOptions:e})))}),500,{leading:!0,trailing:!0})),[d]),b=(0,i.useMemo)((()=>(0,I.debounce)((async()=>{const e=await d.getOptions("name");g((a=>Object.assign({},a,{spanNameOptions:e})))}),500,{leading:!0,trailing:!0})),[d]);(0,i.useEffect)((()=>{(async()=>{try{await d.start();const e=await d.getOptions("service.name"),a=await d.getOptions("name");p(!0),g({serviceNameOptions:e,spanNameOptions:a})}catch(e){404===(null==e?void 0:e.status)?v(e):(0,U.WI)((0,z.$l)((0,$.t_)("Error",e)))}})()}),[d,j,b]);const x=e=>{"Enter"===e.key&&(e.shiftKey||e.ctrlKey)&&o()};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:c.container,children:[(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Service Name",labelWidth:14,grow:!0,children:(0,r.jsx)(l.Select,{menuShouldPortal:!0,options:h.serviceNameOptions,value:a.serviceName||"",onChange:e=>{t(Object.assign({},a,{serviceName:(null==e?void 0:e.value)||void 0}))},placeholder:"Select a service",onOpenMenu:j,isClearable:!0,onKeyDown:x})})}),(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Span Name",labelWidth:14,grow:!0,children:(0,r.jsx)(l.Select,{menuShouldPortal:!0,options:h.spanNameOptions,value:a.spanName||"",onChange:e=>{t(Object.assign({},a,{spanName:(null==e?void 0:e.value)||void 0}))},placeholder:"Select a span",onOpenMenu:b,isClearable:!0,onKeyDown:x})})}),(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Tags",labelWidth:14,grow:!0,tooltip:"Values should be in the logfmt format.",children:(0,r.jsx)(l.QueryField,{additionalPlugins:E,query:a.search,onTypeahead:async e=>await d.provideCompletionItems(e),onBlur:s,onChange:e=>{t(Object.assign({},a,{search:e}))},placeholder:"http.status_code=200 error=true",cleanText:e=>{const a=e.split(/\s+(?=([^"]*"[^"]*")*[^"]*$)/g);return a.length>1?a[a.length-1]:e},onRunQuery:o,syntaxLoaded:u,portalOrigin:"tempo"})})}),(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Min Duration",invalid:!!f.minDuration,labelWidth:14,grow:!0,children:(0,r.jsx)(l.Input,{value:a.minDuration||"",placeholder:B,onBlur:()=>{a.minDuration&&!(0,n.isValidGoDuration)(a.minDuration)?y(Object.assign({},f,{minDuration:!0})):y(Object.assign({},f,{minDuration:!1}))},onChange:e=>t(Object.assign({},a,{minDuration:e.currentTarget.value})),onKeyDown:x})})}),(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Max Duration",invalid:!!f.maxDuration,labelWidth:14,grow:!0,children:(0,r.jsx)(l.Input,{value:a.maxDuration||"",placeholder:B,onBlur:()=>{a.maxDuration&&!(0,n.isValidGoDuration)(a.maxDuration)?y(Object.assign({},f,{maxDuration:!0})):y(Object.assign({},f,{maxDuration:!1}))},onChange:e=>t(Object.assign({},a,{maxDuration:e.currentTarget.value})),onKeyDown:x})})}),(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Limit",invalid:!!f.limit,labelWidth:14,grow:!0,tooltip:"Maximum numbers of returned results",children:(0,r.jsx)(l.Input,{value:a.limit||"",type:"number",onChange:e=>{let s=e.currentTarget.value?parseInt(e.currentTarget.value,10):void 0;s&&(!Number.isInteger(s)||s<=0)?y(Object.assign({},f,{limit:!0})):y(Object.assign({},f,{limit:!1})),t(Object.assign({},a,{limit:e.currentTarget.value?parseInt(e.currentTarget.value,10):void 0}))},onKeyDown:x})})})]}),m?(0,r.jsxs)(l.Alert,{title:"Unable to connect to Tempo search",severity:"info",className:c.alert,children:["Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",(0,r.jsx)("a",{href:`/datasources/edit/${e.uid}`,children:"datasource settings"}),"."]}):null]})},V=e=>({container:d.css`
    max-width: 500px;
  `,alert:d.css`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `});async function K(e){if(!e)return;const a=(0,u.getDataSourceSrv)();try{return await a.get(e)}catch(e){return void console.error("Failed to load data source",e)}}var A,H,Z,Y,X,ee=t("./public/app/features/variables/adhoc/picker/AdHocFilter.tsx");function ae({graphDatasourceUid:e,query:a,onChange:t}){const s=(0,R.Z)((()=>K(e)),[e]);if(s.loading)return null;const n=s.value;if(!e)return A||(A=(0,r.jsx)("div",{className:"text-warning",children:"Please set up a service graph datasource in the datasource settings."}));if(e&&!n)return H||(H=(0,r.jsx)("div",{className:"text-warning",children:"Service graph datasource is configured but the data source no longer exists. Please configure existing data source to use the service graph functionality."}));const i=function(e){let a,t=[];const s=/([\w_]+)(=|!=|<|>|=~|!~)"(.*?)"/g;for(;null!==(a=s.exec(e));)t.push({key:a[1],operator:a[2],value:a[3],condition:""});return t}(a.serviceMapQuery||"");return(0,r.jsx)("div",{children:(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Filter",labelWidth:14,grow:!0,children:(0,r.jsx)(ee.F,{datasource:{uid:e},filters:i,addFilter:e=>{t(Object.assign({},a,{serviceMapQuery:te([...i,e])}))},removeFilter:e=>{const s=[...i];s.splice(e,1),t(Object.assign({},a,{serviceMapQuery:te(s)}))},changeFilter:(e,s)=>{const n=[...i];n.splice(e,1,s),t(Object.assign({},a,{serviceMapQuery:te(n)}))}})})})})}function te(e){return`{${e.map((e=>`${e.key}${e.operator}"${e.value}"`)).join(",")}}`}function se(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class ne extends i.PureComponent{constructor(e){super(e),se(this,"state",{linkedDatasourceUid:void 0,linkedDatasource:void 0,serviceMapDatasourceUid:void 0,serviceMapDatasource:void 0}),se(this,"onChangeLinkedQuery",(e=>{const{query:a,onChange:t}=this.props;t(Object.assign({},a,{linkedQuery:Object.assign({},e,{refId:"linked"})}))})),se(this,"onRunLinkedQuery",(()=>{this.props.onRunQuery()}))}async componentDidMount(){var e;const{datasource:a}=this.props,t=(a.tracesToLogs||{}).datasourceUid,s=null===(e=a.serviceMap)||void 0===e?void 0:e.datasourceUid,[n,i]=await Promise.all([K(t),K(s)]);this.setState({linkedDatasourceUid:t,linkedDatasource:n,serviceMapDatasourceUid:s,serviceMapDatasource:i}),this.props.query.queryType||this.props.onChange(Object.assign({},this.props.query,{queryType:"traceId"}))}render(){var e,a;const{query:t,onChange:s,datasource:n}=this.props,i=n.tracesToLogs||{},o=i.datasourceUid,c=null===(e=n.serviceMap)||void 0===e?void 0:e.datasourceUid,p=[{value:"traceId",label:"TraceID"},{value:"upload",label:"JSON file"}];return u.config.featureToggles.tempoServiceGraph&&p.push({value:"serviceMap",label:"Service Graph"}),!u.config.featureToggles.tempoSearch||null!=n&&null!==(a=n.search)&&void 0!==a&&a.hide||p.unshift({value:"nativeSearch",label:"Search - Beta"}),o&&!1!==(null==i?void 0:i.lokiSearch)&&(u.config.featureToggles.tempoSearch?p.push({value:"search",label:"Loki Search"}):p.unshift({value:"search",label:"Search"})),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Query type",children:(0,r.jsx)(l.RadioButtonGroup,{options:p,value:t.queryType,onChange:e=>s(Object.assign({},t,{queryType:e})),size:"md"})})}),"nativeSearch"===t.queryType&&(0,r.jsxs)("p",{style:{maxWidth:"65ch"},children:[Z||(Z=(0,r.jsx)(l.Badge,{icon:"rocket",text:"Beta",color:"blue"}))," Tempo search is currently in beta and is designed to return recent traces only. It ignores the time range picker. We are actively working on full backend search. Look for improvements in the near future!"]}),"search"===t.queryType&&(0,r.jsx)(ie,{linkedDatasourceUid:o,query:t,onRunQuery:this.onRunLinkedQuery,onChange:this.onChangeLinkedQuery}),"nativeSearch"===t.queryType&&(0,r.jsx)(J,{datasource:this.props.datasource,query:t,onChange:s,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery}),"upload"===t.queryType&&(0,r.jsx)("div",{className:(0,d.css)({padding:this.props.theme.spacing(2)}),children:(0,r.jsx)(l.FileDropzone,{options:{multiple:!1},onLoad:e=>{this.props.datasource.uploadedJson=e,this.props.onRunQuery()}})}),"traceId"===t.queryType&&(0,r.jsx)(l.InlineFieldRow,{children:(0,r.jsx)(l.InlineField,{label:"Trace ID",labelWidth:14,grow:!0,children:(0,r.jsx)(l.QueryField,{query:t.query,onChange:e=>{s(Object.assign({},t,{query:e,queryType:"traceId",linkedQuery:void 0}))},onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery,placeholder:"Enter a Trace ID (run with Shift+Enter)",portalOrigin:"tempo"})})}),"serviceMap"===t.queryType&&(0,r.jsx)(ae,{graphDatasourceUid:c,query:t,onChange:s})]})}}function ie({linkedDatasourceUid:e,onChange:a,onRunQuery:t,query:s}){const n=(0,R.Z)((()=>K(e)),[e]);if(n.loading)return null;const i=n.value;var o;return i?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(l.InlineLabel,{children:["Tempo uses ",i.name," to find traces."]}),(0,r.jsx)(L.n,{datasource:i,onChange:a,onRunQuery:t,query:null!==(o=s.linkedQuery)&&void 0!==o?o:{refId:"linked"},history:[]})]}):e?e&&!i?X||(X=(0,r.jsx)("div",{className:"text-warning",children:"Traces-to-logs datasource is configured but the data source no longer exists. Please configure existing data source to use the search."})):null:Y||(Y=(0,r.jsx)("div",{className:"text-warning",children:"Please set up a Traces-to-logs datasource in the datasource settings."}))}const re=(0,l.withTheme2)(ne),oe=new n.DataSourcePlugin(_).setQueryEditor(re).setConfigEditor((({options:e,onOptionsChange:a})=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l.DataSourceHttpSettings,{defaultUrl:"http://tempo",dataSourceConfig:e,showAccessOptions:!1,onChange:a}),(0,r.jsx)("div",{className:"gf-form-group",children:(0,r.jsx)(c.Z,{options:e,onOptionsChange:a})}),u.config.featureToggles.tempoServiceGraph&&(0,r.jsx)("div",{className:"gf-form-group",children:(0,r.jsx)(p,{options:e,onOptionsChange:a})}),u.config.featureToggles.tempoSearch&&(0,r.jsx)("div",{className:"gf-form-group",children:(0,r.jsx)(m,{options:e,onOptionsChange:a})}),(0,r.jsx)("div",{className:"gf-form-group",children:(0,r.jsx)(f.n,{options:e,onOptionsChange:a})})]}))).setQueryEditorHelp((function(){return s||(s=(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{id:"tempo-cheat-sheet",children:"Tempo Cheat Sheet"}),(0,r.jsx)("p",{children:"Tempo is a trace id lookup store. Enter a trace id in the above field and hit “Run Query” to retrieve your trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces."}),(0,r.jsxs)("p",{children:["Here are some"," ",(0,r.jsx)("a",{href:"https://grafana.com/docs/tempo/latest/guides/instrumentation/",target:"blank",children:"instrumentation examples"})," ","to get you started with trace discovery through logs and metrics (exemplars)."]})]}))}))},"./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/lib/useAsync.js":(e,a,t)=>{var s=t("./.yarn/cache/tslib-npm-2.3.1-0e21e18015-de17a98d46.zip/node_modules/tslib/tslib.es6.js"),n=t("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),i=s.__importDefault(t("./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/lib/useAsyncFn.js"));a.Z=function(e,a){void 0===a&&(a=[]);var t=i.default(e,a,{loading:!0}),s=t[0],r=t[1];return n.useEffect((function(){r()}),[r]),s}}}]);
//# sourceMappingURL=tempoPlugin.787ecc600122eb73aeab.js.map