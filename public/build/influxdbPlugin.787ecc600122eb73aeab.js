"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5783],{"./public/app/plugins/datasource/influxdb/module.ts":(e,t,a)=>{a.r(t),a.d(t,{plugin:()=>vt});var s=a("./.yarn/cache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js"),r=a("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),n=a("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),i=a("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),o=a("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),l=a("./.yarn/cache/rxjs-npm-7.3.0-8a14d1c3d9-e63adb8808.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),u=a("./.yarn/cache/uuid-npm-8.3.0-2f98335399-b539886e6a.zip/node_modules/uuid/dist/esm-browser/v4.js"),d=a("./packages/grafana-runtime/src/index.ts"),c=a("./packages/grafana-data/src/index.ts"),m=a("./public/app/core/table_model.ts");function p(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class h{constructor(e){p(this,"refId",void 0),p(this,"series",void 0),p(this,"alias",void 0),p(this,"annotation",void 0),p(this,"meta",void 0),this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let t,a;return 0===this.series.length||(0,s.each)(this.series,(r=>{const n=r.columns.length,i=(0,s.map)(r.tags,((e,t)=>t+": "+e));for(a=1;a<n;a++){let s=r.name;const n=r.columns[a];"value"!==n&&(s=s+"."+n),this.alias?s=this._getSeriesName(r,a):r.tags&&(s=s+" {"+i.join(", ")+"}");const o=[];if(r.values)for(t=0;t<r.values.length;t++)o[t]=[r.values[t][a],r.values[t][0]];e.push({title:s,target:s,datapoints:o,tags:r.tags,meta:this.meta,refId:this.refId})}})),e}_getSeriesName(e,t){const a=e.name.split(".");return this.alias.replace(/\$(\w+)|\[\[([\s\S]+?)\]\]/g,((s,r,n)=>{const i=r||n,o=parseInt(i,10);if("m"===i||"measurement"===i)return e.name;if("col"===i)return e.columns[t];var l;if(!isNaN(o))return null!==(l=a[o])&&void 0!==l?l:s;if(0!==i.indexOf("tag_"))return s;const u=i.replace("tag_","");return e.tags?e.tags[u]:s}))}getAnnotations(){const e=[];return(0,s.each)(this.series,(t=>{let a=null,r=null,n=null;const i=[];let o=null;(0,s.each)(t.columns,((e,t)=>{"time"!==e?"sequence_number"!==e&&(e!==this.annotation.titleColumn?(0,s.includes)((this.annotation.tagsColumn||"").replace(" ","").split(","),e)?i.push(t):e!==this.annotation.textColumn?e!==this.annotation.timeEndColumn?a||o===t||(a=t):n=t:o=t:a=t):r=t})),(0,s.each)(t.values,(t=>{const l={annotation:this.annotation,time:+new Date(t[r]),title:t[a],timeEnd:t[n],tags:(0,s.flatten)(i.filter((e=>t[e])).map((e=>t[e].split(",")))),text:t[o]};e.push(l)}))})),e}getTable(){const e=new m.Z;let t,a;return e.refId=this.refId,e.meta=this.meta,0===this.series.length||(0,s.each)(this.series,((r,n)=>{if(0===n){const t=r.columns[0],n="time"===t?{text:"Time",type:c.FieldType.time}:{text:t};for(e.columns.push(n),(0,s.each)((0,s.keys)(r.tags),(t=>{e.columns.push({text:t})})),a=1;a<r.columns.length;a++)e.columns.push({text:r.columns[a]})}if(r.values)for(t=0;t<r.values.length;t++){const s=r.values[t],n=[s[0]];if(r.tags)for(const e in r.tags)r.tags.hasOwnProperty(e)&&n.push(r.tags[e]);for(a=1;a<s.length;a++)n.push(s[a]);e.rows.push(n)}})),e}}var g=a("./public/app/angular/components/query_part.ts");const f=[],y={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function v(e){const t=f[e.type];if(!t)throw{message:"Could not find query part "+e.type};return new g.XN(e,t)}function x(e){f[e.type]=new g.zU(e),e.category.push(f[e.type])}const b=[];function j(e,t){return"*"===e.params[0]?"*":'"'+e.params[0]+'"'}function S(e,t){for(let a=0;a<e.length;a++){const s=e[a];if(s.def.category===y.Aggregations){if(s.def.type===t.def.type)return;if("count"===s.def.type&&"distinct"===t.def.type)break;if("distinct"===s.def.type){const s=e.length>=a+2;if("count"!==t.def.type&&s){e[a+1].def.category===y.Aggregations&&e.splice(a+1,1)}else if("count"===t.def.type)return void(s&&"count"===e[a+1].def.type||e.splice(a+1,0,t))}return void(e[a]=t)}if(s.def.category===y.Selectors)return void(e[a]=t)}e.splice(1,0,t)}function w(e,t){let a;for(a=0;a<e.length;a++){const t=e[a];if(t.def.category===y.Math||t.def.category===y.Aliasing)break}e.splice(a,0,t)}x({type:"field",addStrategy:function(e,t,a){const r=(0,s.map)(e,(e=>v({type:e.def.type,params:(0,s.clone)(e.params)})));a.selectModels.push(r)},category:y.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:j}),x({type:"count",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"distinct",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"integral",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"mean",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"median",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"mode",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"sum",addStrategy:S,category:y.Aggregations,params:[],defaultParams:[],renderer:g.D}),x({type:"derivative",addStrategy:w,category:y.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:g.D}),x({type:"spread",addStrategy:w,category:y.Transformations,params:[],defaultParams:[],renderer:g.D}),x({type:"non_negative_derivative",addStrategy:w,category:y.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:g.D}),x({type:"difference",addStrategy:w,category:y.Transformations,params:[],defaultParams:[],renderer:g.D}),x({type:"non_negative_difference",addStrategy:w,category:y.Transformations,params:[],defaultParams:[],renderer:g.D}),x({type:"moving_average",addStrategy:w,category:y.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:g.D}),x({type:"cumulative_sum",addStrategy:w,category:y.Transformations,params:[],defaultParams:[],renderer:g.D}),x({type:"stddev",addStrategy:w,category:y.Transformations,params:[],defaultParams:[],renderer:g.D}),x({type:"time",category:b,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:g.D}),x({type:"fill",category:b,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:g.D}),x({type:"elapsed",addStrategy:w,category:y.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:g.D}),x({type:"holt_winters",addStrategy:w,category:y.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:g.D}),x({type:"holt_winters_with_fit",addStrategy:w,category:y.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:g.D}),x({type:"bottom",addStrategy:S,category:y.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:g.D}),x({type:"first",addStrategy:S,category:y.Selectors,params:[],defaultParams:[],renderer:g.D}),x({type:"last",addStrategy:S,category:y.Selectors,params:[],defaultParams:[],renderer:g.D}),x({type:"max",addStrategy:S,category:y.Selectors,params:[],defaultParams:[],renderer:g.D}),x({type:"min",addStrategy:S,category:y.Selectors,params:[],defaultParams:[],renderer:g.D}),x({type:"percentile",addStrategy:S,category:y.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:g.D}),x({type:"top",addStrategy:S,category:y.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:g.D}),x({type:"tag",category:b,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:j}),x({type:"math",addStrategy:function(e,t){const a=e.length;if(a>0){if("math"===e[a-1].def.type)return void(e[a-1]=t);if(a>1&&"math"===e[a-2].def.type)return void(e[a-2]=t);if("alias"===e[a-1].def.type)return void e.splice(a-1,0,t)}e.push(t)},category:y.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:g.C7}),x({type:"alias",addStrategy:function(e,t){const a=e.length;a>0&&"alias"===e[a-1].def.type?e[a-1]=t:e.push(t)},category:y.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:function(e,t){return t+' AS "'+e.params[0]+'"'}});const C={create:v,getCategories:()=>y,replaceAggregationAdd:S};var T=a("./public/app/core/utils/kbn.ts");function I(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class P{constructor(e,t,a){I(this,"target",void 0),I(this,"selectModels",[]),I(this,"queryBuilder",void 0),I(this,"groupByParts",void 0),I(this,"templateSrv",void 0),I(this,"scopedVars",void 0),I(this,"refId",void 0),this.target=e,this.templateSrv=t,this.scopedVars=a,e.policy=e.policy||"default",e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,s.map)(this.target.select,(e=>(0,s.map)(e,C.create))),this.groupByParts=(0,s.map)(this.target.groupBy,C.create)}updatePersistedParts(){this.target.select=(0,s.map)(this.selectModels,(e=>(0,s.map)(e,(e=>({type:e.def.type,params:e.params})))))}hasGroupByTime(){return(0,s.find)(this.target.groupBy,(e=>"time"===e.type))}hasFill(){return(0,s.find)(this.target.groupBy,(e=>"fill"===e.type))}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const a=t[1],s=t[2],r=C.create({type:a,params:[s]}),n=this.target.groupBy.length;0===n?this.target.groupBy.push(r.part):"time"===a?this.target.groupBy.splice(0,0,r.part):"tag"===a&&"fill"===this.target.groupBy[n-1].type?this.target.groupBy.splice(n-1,0,r.part):this.target.groupBy.push(r.part),this.updateProjection()}removeGroupByPart(e,t){const a=C.getCategories();"time"===e.def.type&&(this.target.groupBy=(0,s.filter)(this.target.groupBy,(e=>"fill"!==e.type)),this.target.select=(0,s.map)(this.target.select,(e=>(0,s.filter)(e,(e=>{const t=C.create(e);return t.def.category!==a.Aggregations&&t.def.category!==a.Selectors}))))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if("field"===t.def.type){if(this.selectModels.length>1){const t=(0,s.indexOf)(this.selectModels,e);this.selectModels.splice(t,1)}}else{const a=(0,s.indexOf)(e,t);e.splice(a,1)}this.updatePersistedParts()}addSelectPart(e,t){const a=C.create({type:t});a.def.addStrategy(e,a,this),this.updatePersistedParts()}renderTagCondition(e,t,a){let s="",r=e.operator,n=e.value;return t>0&&(s=(e.condition||"AND")+" "),r||(r=/^\/.*\/$/.test(n)?"=~":"="),"=~"!==r&&"!~"!==r?(a&&(n=this.templateSrv.replace(n,this.scopedVars)),">"!==r&&"<"!==r&&(n="'"+n.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'")):a&&(n=this.templateSrv.replace(n,this.scopedVars,"regex")),s+'"'+e.key+'" '+r+" "+n}getMeasurementAndPolicy(e){let t=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?e&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',t="default"!==t?'"'+this.target.policy+'".':"",t+a}interpolateQueryStr(e,t,a){if(!t.multi&&!t.includeAll)return e;if("string"==typeof e)return T.Z.regexEscape(e);return"("+(0,s.map)(e,T.Z.regexEscape).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let a,r,n="SELECT ";for(a=0;a<this.selectModels.length;a++){const e=this.selectModels[a];let t="";for(r=0;r<e.length;r++){t=e[r].render(t)}a>0&&(n+=", "),n+=t}n+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const i=(0,s.map)(t.tags,((t,a)=>this.renderTagCondition(t,a,e)));i.length>0&&(n+="("+i.join(" ")+") AND "),n+="$timeFilter";let o="";for(a=0;a<this.groupByParts.length;a++){const e=this.groupByParts[a];a>0&&(o+="fill"===e.def.type?" ":", "),o+=e.render("")}return o.length&&(n+=" GROUP BY "+o),t.fill&&(n+=" fill("+t.fill+")"),"DESC"===t.orderByTime&&(n+=" ORDER BY time DESC"),t.limit&&(n+=" LIMIT "+t.limit),t.slimit&&(n+=" SLIMIT "+t.slimit),t.tz&&(n+=" tz('"+t.tz+"')"),n}renderAdhocFilters(e){const t=(0,s.map)(e,((e,t)=>this.renderTagCondition(e,t,!0)));return t.join(" ")}}P.$inject=["target","templateSrv","scopedVars"];class E{parse(e,t){if(null==t||!t.results||0===t.results.length)return[];const a=t.results[0];if(!a.series)return[];const r=e.toLowerCase(),n=r.indexOf("show field keys")>=0||r.indexOf("show retention policies")>=0,i=new Set;return(0,s.each)(a.series,(e=>{(0,s.each)(e.values,(e=>{(0,s.isArray)(e)?n?O(i,e[0]):void 0!==e[1]?O(i,e[1]):O(i,e[0]):O(i,e)}))})),Array.from(i).map((e=>({text:e})))}}function O(e,t){e.add(t.toString())}class F{constructor(e,t){this.target=e,this.database=t,this.target=e,this.database=t}buildExploreQuery(e,t,a){let r,n,i="";if("TAG_KEYS"===e)i="SHOW TAG KEYS",r=this.target.measurement,n=this.target.policy;else if("TAG_VALUES"===e)i="SHOW TAG VALUES",r=this.target.measurement,n=this.target.policy;else if("MEASUREMENTS"===e)i="SHOW MEASUREMENTS",a&&(i+=" WITH MEASUREMENT =~ /(?i)"+T.Z.regexEscape(a)+"/");else{if("FIELDS"===e)return r=this.target.measurement,n=this.target.policy,r.match("^/.*/")||(r='"'+r+'"',n&&"default"!==n&&(n='"'+n+'"',r=n+"."+r)),"SHOW FIELD KEYS FROM "+r;if("RETENTION POLICIES"===e)return i='SHOW RETENTION POLICIES on "'+this.database+'"',i}if(r&&(r.match("^/.*/")||r.match(/^merge\(.*\)/)||(r='"'+r+'"'),n&&"default"!==n&&(n='"'+n+'"',r=n+"."+r),i+=" FROM "+r),t&&(i+=' WITH KEY = "'+t+'"'),this.target.tags&&this.target.tags.length>0){const e=(0,s.reduce)(this.target.tags,((e,a)=>(a.key===t||">"===a.operator||"<"===a.operator||e.push(function(e,t){let a="",s=e.operator,r=e.value;return t>0&&(a=(e.condition||"AND")+" "),s||(s=/^\/.*\/$/.test(e.value)?"=~":"="),(""===r||"=~"!==s&&"!~"!==s&&isNaN(+r))&&(r="'"+r.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),a+'"'+e.key+'" '+s+" "+r}(a,e.length)),e)),[]);e.length>0&&(i+=" WHERE "+e.join(" "))}return"MEASUREMENTS"===e&&(i+=" LIMIT 100"),i}}let D;!function(e){e.InfluxQL="InfluxQL",e.Flux="Flux"}(D||(D={}));var N,_,k,A=a("./public/app/features/templating/template_srv.ts"),R=a("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js"),M=a("./.yarn/__virtual__/@emotion-css-virtual-9fd25d72e0/0/cache/@emotion-css-npm-11.1.3-72aa05c30f-dc50283f65.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),B=a("./packages/grafana-ui/src/index.ts"),q=a("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/jsx-runtime.js");function L(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const Q=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:'from(bucket: "db/rp")\n  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)\n  |> filter(fn: (r) =>\n    r._measurement == "example-measurement" and\n    r._field == "example-field"\n  )'},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:'// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)\nfrom(bucket: v.bucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)\n  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)\n  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)\n  |> yield(name: "some-name")'},{label:"Filter by value",description:"Results between a min/max",value:'// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb\nfrom(bucket: v.bucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)'},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:'import "influxdata/influxdb/v1"\nv1.measurements(bucket: v.bucket)'},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:'from(bucket: v.bucket)\n  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)\n  |> keys()\n  |> keep(columns: ["_value"])\n  |> group()\n  |> distinct()'},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:'import "influxdata/influxdb/v1"\nv1.tagKeys(bucket: v.bucket)'},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:'import "influxdata/influxdb/v1"\nv1.tagValues(\n    bucket: v.bucket,\n    tag: "host",\n    predicate: (r) => true,\n    start: -1d\n)'}];class V extends R.PureComponent{constructor(...e){super(...e),L(this,"onFluxQueryChange",(e=>{this.props.onChange(Object.assign({},this.props.query,{query:e})),this.props.onRunQuery()})),L(this,"onSampleChange",(e=>{this.props.onChange(Object.assign({},this.props.query,{query:e.value})),this.forceUpdate(),this.props.onRunQuery()})),L(this,"getSuggestions",(()=>{const e=[{label:"v.timeRangeStart",kind:B.CodeEditorSuggestionItemKind.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:B.CodeEditorSuggestionItemKind.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:B.CodeEditorSuggestionItemKind.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:B.CodeEditorSuggestionItemKind.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:B.CodeEditorSuggestionItemKind.Property,detail:"org configured for the datsource"}],t=(0,d.getTemplateSrv)();return t.getVariables().forEach((a=>{const s="${"+a.name+"}";let r=t.replace(s);r===s&&(r=""),e.push({label:s,kind:B.CodeEditorSuggestionItemKind.Text,detail:`(Template Variable) ${r}`})})),e})),L(this,"editorDidMountCallbackHack",(e=>{setTimeout((()=>e.layout()),100)}))}render(){const{query:e}=this.props,t=N||(N=(0,q.jsxs)("div",{children:["Type: ",(0,q.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,q.jsx)("br",{}),"Many queries can be copied from Chronograf"]}));return(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)(B.CodeEditor,{height:"200px",language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),(0,q.jsxs)("div",{className:(0,M.cx)("gf-form-inline",M.css`
              margin-top: 6px;
            `),children:[_||(_=(0,q.jsx)(B.LinkButton,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/",children:"Flux language syntax"})),(0,q.jsx)(B.Segment,{options:Q,value:"Sample Query",onChange:this.onSampleChange}),k||(k=(0,q.jsx)("div",{className:"gf-form gf-form--grow",children:(0,q.jsx)("div",{className:"gf-form-label gf-form-label--grow"})})),(0,q.jsx)(B.InlineFormLabel,{width:5,tooltip:t,children:"Help"})]})]})}}function $(e){const t=(0,s.cloneDeep)(e);return new P(t).render(!1)}const z=["__interval","__interval_ms"];function G(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function U(e){const t=e.find((e=>null!==e));if(void 0===t)return c.FieldType.number;const a=typeof t;switch(a){case"string":return c.FieldType.string;case"boolean":return c.FieldType.boolean;case"number":return c.FieldType.number;default:throw new Error(`InfluxQL: invalid value type ${a}`)}}function W(e){const t=[],a=[],s=e.datapoints;for(const e of s)a.push(e[0]),t.push(e[1]);const r=[{name:c.TIME_SERIES_TIME_FIELD_NAME,type:c.FieldType.time,config:{},values:new c.ArrayVector(t)},{name:c.TIME_SERIES_VALUE_FIELD_NAME,type:U(a),config:{displayNameFromDS:e.title},values:new c.ArrayVector(a),labels:e.tags}];return{name:e.target,refId:e.refId,meta:e.meta,fields:r,length:a.length}}class H extends d.DataSourceWithBackend{constructor(e,t=(0,A.J)()){var a,s,r;super(e),G(this,"type",void 0),G(this,"urls",void 0),G(this,"username",void 0),G(this,"password",void 0),G(this,"name",void 0),G(this,"database",void 0),G(this,"basicAuth",void 0),G(this,"withCredentials",void 0),G(this,"interval",void 0),G(this,"responseParser",void 0),G(this,"httpMode",void 0),G(this,"isFlux",void 0),this.templateSrv=t,this.templateSrv=t,this.type="influxdb",this.urls=(null!==(a=e.url)&&void 0!==a?a:"").split(",").map((e=>e.trim())),this.username=null!==(s=e.username)&&void 0!==s?s:"",this.password=null!==(r=e.password)&&void 0!==r?r:"",this.name=e.name,this.database=e.database,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials;const n=e.jsonData||{};this.interval=n.timeInterval,this.httpMode=n.httpMode||"GET",this.responseParser=new E,this.isFlux=n.version===D.Flux,this.isFlux&&(this.annotations={QueryEditor:V})}query(e){if(this.isFlux){const t=Object.assign({},e,{targets:e.targets.filter((e=>!0!==e.hide))});return super.query(t)}return this.classicQuery(e)}getQueryDisplayText(e){return this.isFlux?e.query:new P(e).render(!1)}filterQuery(e){return!this.isFlux||!!e.query}applyTemplateVariables(e,t){var a;if(!this.isFlux)throw new Error("applyTemplateVariables called in influxql-mode. this should never happen");const s=function(e,t){if(null==e)return{};var a,s,r={},n=Object.keys(e);for(s=0;s<n.length;s++)a=n[s],t.indexOf(a)>=0||(r[a]=e[a]);return r}(t,z);return Object.assign({},e,{query:this.templateSrv.replace(null!==(a=e.query)&&void 0!==a?a:"",s)})}classicQuery(e){let t=this.getTimeFilter(e);const a=e.scopedVars,n=(0,s.cloneDeep)(e.targets),i=[];let l,u,d=(0,s.map)(n,(e=>e.hide?"":(i.push(e),a.interval=a.__interval,new P(e,this.templateSrv,a).render(!0)))).reduce(((e,t)=>(""!==t&&(e+=";"+t),e)));if(""===d)return(0,r.of)({data:[]});const c=this.templateSrv.getAdhocFilters(this.name);if(c.length>0){t+=" AND "+new P({refId:"A"},this.templateSrv,a).renderAdhocFilters(c)}return a.timeFilter={value:t},d=this.templateSrv.replace(d,a),this._seriesQuery(d,e).pipe((0,o.U)((t=>{if(!t||!t.results)return{data:[]};const a=[];for(l=0;l<t.results.length;l++){const s=t.results[l];if(!s||!s.series)continue;const r=i[l];let n=r.alias;n&&(n=this.templateSrv.replace(r.alias,e.scopedVars));const o={executedQueryString:t.executedQueryString},d=new h({refId:r.refId,series:t.results[l].series,alias:n,meta:o});switch(r.resultFormat){case"logs":o.preferredVisualisationType="logs";case"table":a.push(d.getTable());break;default:{const e=d.getTimeSeries();for(u=0;u<e.length;u++)a.push(W(e[u]));break}}}return{data:a}})))}async annotationQuery(e){if(this.isFlux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!e.annotation.query)return Promise.reject({message:"Query missing in annotation definition"});const t=this.getTimeFilter({rangeRaw:e.rangeRaw,timezone:e.dashboard.timezone});let a=e.annotation.query.replace("$timeFilter",t);return a=this.templateSrv.replace(a,void 0,"regex"),(0,n.n)(this._seriesQuery(a,e)).then((t=>{if(!t||!t.results||!t.results[0])throw{message:"No results in response from InfluxDB"};return new h({series:t.results[0].series,annotation:e.annotation}).getAnnotations()}))}targetContainsTemplate(e){const t=this.isFlux?e.query:$(e);return this.templateSrv.variableExists(t)}interpolateVariablesInQueries(e,t){if(!e||0===e.length)return[];let a=e;return e&&e.length>0&&(a=e.map((e=>{var a,s;const r=Object.assign({},e,{datasource:this.getRef(),measurement:this.templateSrv.replace(null!==(a=e.measurement)&&void 0!==a?a:"",t,"regex"),policy:this.templateSrv.replace(null!==(s=e.policy)&&void 0!==s?s:"",t,"regex")});var n;(e.rawQuery||this.isFlux)&&(r.query=this.templateSrv.replace(null!==(n=e.query)&&void 0!==n?n:"",t,"regex"));return e.tags&&(r.tags=e.tags.map((e=>Object.assign({},e,{value:this.templateSrv.replace(e.value,void 0,"regex")})))),r}))),a}async metricFindQuery(e,t){if(this.isFlux){const a={refId:"metricFindQuery",query:e};return(0,n.n)(super.query(Object.assign({},t,{targets:[a]}))).then((e=>{var t;return null!==(t=e.data)&&void 0!==t&&t.length?(0,d.frameToMetricFindValue)(e.data[0]):[]}))}const a=this.templateSrv.replace(e,void 0,"regex");return(0,n.n)(this._seriesQuery(a,t)).then((t=>this.responseParser.parse(e,t)))}getTagKeys(e={}){const t=new F({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(t,e)}getTagValues(e={}){const t=new F({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",e.key);return this.metricFindQuery(t,e)}_seriesQuery(e,t){if(!e)return(0,r.of)({results:[]});if(t&&t.range){const a=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",a)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?(0,s.reduce)(e,((e,t,a)=>(null==t||e.push(encodeURIComponent(a)+"="+encodeURIComponent(t)),e)),[]).join("&"):""}testDatasource(){if(this.isFlux){const e={targets:[{refId:"test",query:"buckets()"}],requestId:`${this.id}-health-${(0,u.Z)()}`,dashboardId:0,panelId:0,interval:"1m",intervalMs:6e4,maxDataPoints:423,range:{from:(0,c.dateTime)(1e3),to:(0,c.dateTime)(2e3)}};return(0,n.n)(super.query(e)).then((e=>{if(!e||!e.data||e.state!==c.LoadingState.Done)return console.error("InfluxDB Error",e),{status:"error",message:"Error reading InfluxDB"};const t=e.data[0];return t&&t.length?{status:"success",message:`${t.length} buckets found`}:(console.error("InfluxDB Error",e),{status:"error",message:"Error reading buckets"})})).catch((e=>(console.error("InfluxDB Error",e),{status:"error",message:e.message})))}const e=new F({measurement:"",tags:[]},this.database).buildExploreQuery("RETENTION POLICIES");return(0,n.n)(this._seriesQuery(e)).then((e=>{const t=(0,s.get)(e,"results[0].error");return t?{status:"error",message:t}:{status:"success",message:"Data source is working"}})).catch((e=>({status:"error",message:e.message})))}_influxRequest(e,t,a,n){const u=this.urls.shift();this.urls.push(u);const c={};this.username&&(c.u=this.username,c.p=this.password),n&&n.database?c.db=n.database:this.database&&(c.db=this.database);const{q:m}=a;"POST"===e&&(0,s.has)(a,"q")?((0,s.extend)(c,(0,s.omit)(a,["q"])),a=this.serializeParams((0,s.pick)(a,["q"]))):"GET"!==e&&"POST"!==e||((0,s.extend)(c,a),a=null);const p={method:e,url:u+t,params:c,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return p.headers=p.headers||{},(this.basicAuth||this.withCredentials)&&(p.withCredentials=!0),this.basicAuth&&(p.headers.Authorization=this.basicAuth),"POST"===e&&(p.headers["Content-type"]="application/x-www-form-urlencoded"),(0,d.getBackendSrv)().fetch(p).pipe((0,o.U)((e=>{const{data:t}=e;if(t&&(t.executedQueryString=m,t.results)){const a=e.data.results.filter((e=>e.error));if(a.length>0)throw{message:"InfluxDB Error: "+a[0].error,data:t}}return t})),(0,l.K)((e=>e.cancelled?(0,r.of)(e):(0,i._)(this.handleErrors(e)))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&0!==e.status||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){return"time >= "+this.getInfluxTime(e.rangeRaw.from,!1,e.timezone)+" and time <= "+this.getInfluxTime(e.rangeRaw.to,!0,e.timezone)}getInfluxTime(e,t,a){if((0,s.isString)(e)){if("now"===e)return"now()";const s=/^now-(\d+)([dhms])$/.exec(e);if(s){return"now() - "+parseInt(s[1],10)+s[2]}e=c.dateMath.parse(e,t,a)}return e.valueOf()+"ms"}}var K=a("./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/esm/usePrevious.js");function J(e){const[t,a]=(0,R.useState)(e),s=(0,K.Z)(e);return(0,R.useEffect)((()=>{s!==e&&t!==e&&a(e)}),[e,t,s]),[t,a]}var Y=a("./public/app/plugins/datasource/influxdb/components/useUniqueId.ts");const Z=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],X="time_series",ee=({query:e,onChange:t,onRunQuery:a})=>{var s;const[r,n]=J(e.query),[i,o]=J(e.alias),l=(0,Y.L)(),u=(0,Y.L)(),d=null!==(s=e.resultFormat)&&void 0!==s?s:X,c=()=>{t(Object.assign({},e,{query:r,alias:i,resultFormat:d})),a()};return(0,q.jsxs)("div",{children:[(0,q.jsx)(B.TextArea,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:c,onChange:e=>{n(e.currentTarget.value)},value:null!=r?r:""}),(0,q.jsxs)(B.HorizontalGroup,{children:[(0,q.jsx)(B.InlineFormLabel,{htmlFor:u,children:"Format as"}),(0,q.jsx)(B.Select,{menuShouldPortal:!0,inputId:u,onChange:s=>{t(Object.assign({},e,{resultFormat:s.value})),a()},value:d,options:Z}),(0,q.jsx)(B.InlineFormLabel,{htmlFor:l,children:"Alias by"}),(0,q.jsx)(B.Input,{id:l,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:c,onChange:e=>{o(e.currentTarget.value)},value:null!=i?i:""})]})]})};var te=a("./.yarn/cache/debounce-promise-npm-3.1.2-3c185da0c7-29bac4524c.zip/node_modules/debounce-promise/dist/index.js"),ae=a.n(te),se=a("./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/esm/useAsyncFn.js");const re=(0,M.css)({minWidth:"160px"}),ne=e=>e,ie=({loadOptions:e,allowCustomValue:t,onChange:a,onClose:s})=>{const r=ae()(e,1e3,{leading:!0});return(0,q.jsx)("div",{className:re,children:(0,q.jsx)(B.AsyncSelect,{menuShouldPortal:!0,formatCreateLabel:ne,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:s,allowCustomValue:t,loadOptions:r,onChange:a})})},oe=({loadOptions:e,allowCustomValue:t,onChange:a,onClose:s})=>{var r;const[n,i]=(0,se.Z)(e,[e]);return(0,R.useEffect)((()=>{i("")}),[i,e]),(0,q.jsx)("div",{className:re,children:(0,q.jsx)(B.Select,{menuShouldPortal:!0,isLoading:n.loading,formatCreateLabel:ne,autoFocus:!0,isOpen:!0,onCloseMenu:s,allowCustomValue:t,options:null!==(r=n.value)&&void 0!==r?r:[],onChange:a})})},le=({loadOptions:e,filterByLoadOptions:t,allowCustomValue:a,onChange:s,onClose:r})=>t?(0,q.jsx)(ie,{loadOptions:e,allowCustomValue:a,onChange:s,onClose:r}):(0,q.jsx)(oe,{loadOptions:e,allowCustomValue:a,onChange:s,onClose:r}),ue=({initialValue:e,onChange:t,onClose:a})=>{const[s,r]=J(e);return(0,q.jsx)(B.Input,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:a,onKeyDown:e=>{"Enter"===e.key&&t(s)},onChange:e=>{r(e.currentTarget.value)},value:s})},de=(0,M.css)({width:"auto",cursor:"pointer"}),ce=({value:e,buttonClassName:t,loadOptions:a,filterByLoadOptions:s,allowCustomValue:r,onChange:n})=>{const[i,o]=(0,R.useState)(!1);if(i)return void 0!==a?(0,q.jsx)(le,{loadOptions:a,filterByLoadOptions:null!=s&&s,allowCustomValue:r,onChange:e=>{o(!1),n(e)},onClose:()=>{o(!1)}}):(0,q.jsx)(ue,{initialValue:e,onClose:()=>{o(!1)},onChange:e=>{o(!1),n({value:e,label:e})}});{const a=(0,M.cx)(de,t);return(0,q.jsx)(B.InlineLabel,{as:"button",className:a,onClick:()=>{o(!0)},children:e})}};function me(e){return{label:e,value:e}}const pe=({policy:e,measurement:t,onChange:a,getPolicyOptions:s,getMeasurementOptions:r})=>(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)(ce,{allowCustomValue:!0,value:null!=e?e:"using default policy",loadOptions:async()=>{const e=await s();return(e.some((e=>"default"===e))?e:["default",...e]).map(me)},onChange:e=>{a(e.value,t)}}),(0,q.jsx)(ce,{allowCustomValue:!0,value:null!=t?t:"select measurement",loadOptions:async e=>(await r(e)).map(me),filterByLoadOptions:!0,onChange:t=>{a(e,t.value)}})]});function he(e){return/^\/.*\/$/.test(e)}function ge(e){var t;return null!==(t=e.operator)&&void 0!==t?t:he(e.value)?"=~":"="}function fe(e,t){var a;return t?void 0:null!==(a=e.condition)&&void 0!==a?a:"AND"}function ye(e,t){const a="=~"===e||"!~"===e;return he(t)?a?e:"=~":a?"=":e}function ve(e){if(null==e)throw new Error("value must not be nullish");return e}const xe=({loadOptions:e,allowCustomValue:t,onAdd:a})=>(0,q.jsx)(ce,{value:"+",loadOptions:e,allowCustomValue:t,onChange:e=>{a(ve(e.value))}}),be=["=","!=","<>","<",">","=~","!~"].map(me),je=["AND","OR"].map(me),Se=()=>Promise.resolve(je),we=()=>Promise.resolve(be),Ce=({tag:e,isFirst:t,onRemove:a,onChange:s,getTagKeyOptions:r,getTagValueOptions:n})=>{const i=ge(e),o=fe(e,t);return(0,q.jsxs)("div",{className:"gf-form",children:[null!=o&&(0,q.jsx)(ce,{value:o,loadOptions:Se,onChange:t=>{s(Object.assign({},e,{condition:t.value}))}}),(0,q.jsx)(ce,{allowCustomValue:!0,value:e.key,loadOptions:()=>r().catch((e=>(console.error(e),[]))).then((e=>[{label:"-- remove filter --",value:void 0},...e.map(me)])),onChange:t=>{const{value:r}=t;void 0===r?a():s(Object.assign({},e,{key:null!=r?r:""}))}}),(0,q.jsx)(ce,{value:i,loadOptions:we,onChange:t=>{s(Object.assign({},e,{operator:t.value}))}}),(0,q.jsx)(ce,{allowCustomValue:!0,value:e.value,loadOptions:()=>n(e.key).then((e=>e.map(me))),onChange:t=>{var a;const r=null!==(a=t.value)&&void 0!==a?a:"";s(Object.assign({},e,{value:r,operator:ye(i,r)}))}})]})},Te=({tags:e,onChange:t,getTagKeyOptions:a,getTagValueOptions:s})=>(0,q.jsxs)(q.Fragment,{children:[e.map(((r,n)=>(0,q.jsx)(Ce,{tag:r,isFirst:0===n,onChange:a=>{((a,s)=>{const r=e.map(((e,t)=>s===t?a:e));t(r)})(a,n)},onRemove:()=>{(a=>{const s=e.filter(((e,t)=>t!==a));t(s)})(n)},getTagKeyOptions:a,getTagValueOptions:s},n))),(0,q.jsx)(xe,{allowCustomValue:!0,loadOptions:()=>a().then((e=>e.map(me))),onAdd:a=>{((a,s)=>{const r={key:a,value:"select tag value"},n={key:r.key,value:r.value,operator:ge(r),condition:fe(r,s)};t([...e,n])})(a,0===e.length)}})]}),Ie=(0,M.css)({paddingRight:"0",marginRight:"0"}),Pe=({name:e,onRemove:t})=>(0,q.jsx)(B.WithContextMenu,{renderMenuItems:()=>{return e=t,(0,q.jsx)(B.MenuGroup,{label:"",children:(0,q.jsx)(B.MenuItem,{label:"remove",onClick:e})});var e},children:({openMenu:t})=>(0,q.jsx)("button",{className:(0,M.cx)("gf-form-label",Ie),onClick:t,children:e})}),Ee=(0,M.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),Oe=({name:e,params:t,onChange:a,onRemove:s})=>{const r=(0,B.useTheme2)(),n=(0,R.useMemo)((()=>(e=>(0,M.cx)("gf-form-label",(0,M.css)({paddingLeft:"0",lineHeight:e.typography.body.lineHeight,fontSize:e.typography.body.fontSize})))(r)),[r]);return(0,q.jsxs)("div",{className:n,children:[(0,q.jsx)(Pe,{name:e,onRemove:s}),"(",t.map(((e,s)=>{const{value:r,options:n}=e,i=s===t.length-1,o=null!==n?()=>n().then((e=>e.map(me))):void 0;return(0,q.jsxs)(R.Fragment,{children:[(0,q.jsx)(ce,{allowCustomValue:!0,value:r,buttonClassName:Ee,loadOptions:o,onChange:e=>{((e,s)=>{const r=t.map((e=>e.value));r[s]=e,a(r)})(ve(e.value),s)}}),!i&&","]},s)})),")"]})},Fe=({parts:e,getNewPartOptions:t,onAddNewPart:a,onRemovePart:s,onChange:r})=>(0,q.jsxs)(q.Fragment,{children:[e.map(((e,t)=>(0,q.jsx)(Oe,{name:e.name,params:e.params,onRemove:()=>{s(t)},onChange:e=>{r(t,e)}},t))),(0,q.jsx)(xe,{loadOptions:t,onAdd:a})]}),De=(0,M.css)({paddingRight:"4px"}),Ne=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],_e=(0,M.cx)("width-9",De),ke=({value:e,onChange:t,inputId:a})=>(0,q.jsx)(q.Fragment,{children:(0,q.jsx)(B.Select,{inputId:a,className:_e,onChange:e=>{t(ve(e.value))},value:e,options:Ne})}),Ae=({value:e,onChange:t,isWide:a,placeholder:s})=>{const[r,n]=J(e);return(0,q.jsx)(q.Fragment,{children:(0,q.jsx)(B.Input,{placeholder:s,className:(0,M.cx)(null!=a&&a?"width-14":"width-8",De),type:"text",spellCheck:!1,onBlur:()=>{t(""===r?void 0:r)},onChange:e=>{n(e.currentTarget.value)},value:null!=r?r:""})})},Re=(e,t,a,s,r)=>{const n=new F(s,r.database).buildExploreQuery(e,t,a);return r.metricFindQuery(n)};async function Me(e,t,a,s){const r={tags:a,measurement:e,policy:t};return(await Re("TAG_KEYS",void 0,void 0,r,s)).map((e=>e.text))}const Be=(0,M.cx)("width-8",De),qe=({format:e,inputId:t,onChange:a})=>(0,q.jsx)(B.Select,{inputId:t,className:Be,onChange:e=>{a(ve(e.value))},value:e,options:Z});function Le(e,t){var a;const s=C.create(e).def,r=(null!==(a=e.params)&&void 0!==a?a:[]).map((e=>e.toString()));if(r.length!==s.params.length)throw new Error("Invalid query-segment");return r.map(((e,a)=>{const r=s.params[a];return r.dynamicLookup?{value:e,options:ve(t.get(`${s.type}_${a}`))}:null!=r.options?{value:e,options:()=>Promise.resolve(r.options)}:{value:e,options:null}}))}function Qe(e,t){return e.map((e=>({name:e.type,params:Le(e,t)})))}function Ve(e){return e.then((e=>[...(0,d.getTemplateSrv)().getVariables().map((e=>`/^$${e.name}$/`)),...e]))}function $e(e,t){return e.filter((e=>t.has(e.key)))}const ze=e=>{var t,a,r,n;const i=(0,Y.L)(),o=`influxdb-qe-format-as-${i}`,l=`influxdb-qe-order-by${i}`,u=(0,B.useStyles2)(Ge),d=function(e){if(void 0!==e.policy&&void 0!==e.resultFormat&&void 0!==e.orderByTime&&void 0!==e.tags&&void 0!==e.groupBy&&void 0!==e.select)return e;const t=(0,s.cloneDeep)(e);return new P(t).target}(e.query),{datasource:c}=e,{measurement:m,policy:p}=d,h=(0,R.useMemo)((()=>Me(m,p,[],c).then((e=>new Set(e)))),[m,p,c]),g=(0,R.useMemo)((()=>{var e;const t=new Map([["field_0",()=>void 0!==m?async function(e,t,a){const s={tags:[],measurement:e,policy:t};return(await Re("FIELDS",void 0,void 0,s,a)).map((e=>e.text))}(m,p,c):Promise.resolve([])]]);return(null!==(e=d.select)&&void 0!==e?e:[]).map((e=>Qe(e,t)))}),[m,p,d.select,c]),f=(0,R.useMemo)((()=>()=>h.then((e=>{var t;return Me(m,p,$e(null!==(t=d.tags)&&void 0!==t?t:[],e),c)}))),[m,p,d.tags,c,h]),y=(0,R.useMemo)((()=>{var e;const t=new Map([["tag_0",f]]);return Qe(null!==(e=d.groupBy)&&void 0!==e?e:[],t)}),[f,d.groupBy]),v=t=>{e.onChange(t),e.onRunQuery()};return(0,q.jsxs)("div",{children:[(0,q.jsxs)(B.SegmentSection,{label:"FROM",fill:!0,children:[(0,q.jsx)(pe,{policy:p,measurement:m,getPolicyOptions:()=>async function(e){const t={tags:[],measurement:void 0,policy:void 0};return(await Re("RETENTION POLICIES",void 0,void 0,t,e)).map((e=>e.text))}(c),getMeasurementOptions:e=>Ve(h.then((t=>{var a;return async function(e,t,a){const s={tags:t,measurement:void 0,policy:void 0};return(await Re("MEASUREMENTS",void 0,e,s,a)).map((e=>e.text))}(""===e?void 0:e,$e(null!==(a=d.tags)&&void 0!==a?a:[],t),c)}))),onChange:(e,t)=>{v(Object.assign({},d,{policy:e,measurement:t}))}}),(0,q.jsx)(B.InlineLabel,{width:"auto",className:u.inlineLabel,children:"WHERE"}),(0,q.jsx)(Te,{tags:null!==(t=d.tags)&&void 0!==t?t:[],onChange:e=>{v(Object.assign({},d,{tags:0===e.length?void 0:e}))},getTagKeyOptions:f,getTagValueOptions:e=>Ve(h.then((t=>{var a;return async function(e,t,a,s,r){const n={tags:s,measurement:t,policy:a};return(await Re("TAG_VALUES",e,void 0,n,r)).map((e=>e.text))}(e,m,p,$e(null!==(a=d.tags)&&void 0!==a?a:[],t),c)})))})]}),g.map(((e,t)=>(0,q.jsx)(B.SegmentSection,{label:0===t?"SELECT":"",fill:!0,children:(0,q.jsx)(Fe,{parts:e,getNewPartOptions:()=>Promise.resolve(function(){const e=C.getCategories(),t=[];return Object.keys(e).forEach((a=>{const s=e[a].map((e=>me(e.type)));t.push({label:a,options:s})})),t}()),onChange:(e,a)=>{const s=function(e,t,a,s){var r;const n=[...null!==(r=e.select)&&void 0!==r?r:[]];return n[t]=[...n[t]],n[t][a]=Object.assign({},n[t][a],{params:s}),Object.assign({},e,{select:n})}(d,t,e,a);v(s)},onAddNewPart:e=>{v(function(e,t,a){const r=(0,s.cloneDeep)(e),n=new P(r);return n.addSelectPart(n.selectModels[a],t),n.target}(d,e,t))},onRemovePart:e=>{v(function(e,t,a){const r=(0,s.cloneDeep)(e),n=new P(r),i=n.selectModels[a];return n.removeSelectPart(i,i[t]),n.target}(d,e,t))}})},t))),(0,q.jsx)(B.SegmentSection,{label:"GROUP BY",fill:!0,children:(0,q.jsx)(Fe,{parts:y,getNewPartOptions:()=>async function(e,t){const a=await t(),s=Object.assign({},e),r=new P(s),n=[];return r.hasFill()||n.push(me("fill(null)")),r.hasGroupByTime()||n.push(me("time($interval)")),a.forEach((e=>{n.push(me(`tag(${e})`))})),n}(d,f),onChange:(e,t)=>{const a=function(e,t,a){var s;const r=[...null!==(s=e.groupBy)&&void 0!==s?s:[]];return r[t]=Object.assign({},r[t],{params:a}),Object.assign({},e,{groupBy:r})}(d,e,t);v(a)},onAddNewPart:e=>{v(function(e,t){const a=(0,s.cloneDeep)(e),r=new P(a);return r.addGroupBy(t),r.target}(d,e))},onRemovePart:e=>{v(function(e,t){const a=(0,s.cloneDeep)(e),r=new P(a);return r.removeGroupByPart(r.groupByParts[t],t),r.target}(d,e))}})}),(0,q.jsxs)(B.SegmentSection,{label:"TIMEZONE",fill:!0,children:[(0,q.jsx)(Ae,{placeholder:"(optional)",value:d.tz,onChange:e=>{v(Object.assign({},d,{tz:e}))}}),(0,q.jsx)(B.InlineLabel,{htmlFor:l,width:"auto",className:u.inlineLabel,children:"ORDER BY TIME"}),(0,q.jsx)(ke,{inputId:l,value:"DESC"===d.orderByTime?"DESC":"ASC",onChange:e=>{v(Object.assign({},d,{orderByTime:e}))}})]}),(0,q.jsxs)(B.SegmentSection,{label:"LIMIT",fill:!0,children:[(0,q.jsx)(Ae,{placeholder:"(optional)",value:null===(a=d.limit)||void 0===a?void 0:a.toString(),onChange:e=>{v(Object.assign({},d,{limit:e}))}}),(0,q.jsx)(B.InlineLabel,{width:"auto",className:u.inlineLabel,children:"SLIMIT"}),(0,q.jsx)(Ae,{placeholder:"(optional)",value:null===(r=d.slimit)||void 0===r?void 0:r.toString(),onChange:e=>{v(Object.assign({},d,{slimit:e}))}})]}),(0,q.jsxs)(B.SegmentSection,{htmlFor:o,label:"FORMAT AS",fill:!0,children:[(0,q.jsx)(qe,{inputId:o,format:null!==(n=d.resultFormat)&&void 0!==n?n:X,onChange:e=>{v(Object.assign({},d,{resultFormat:e}))}}),"table"!==d.resultFormat&&(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)(B.InlineLabel,{width:"auto",className:u.inlineLabel,children:"ALIAS"}),(0,q.jsx)(Ae,{isWide:!0,placeholder:"Naming pattern",value:d.alias,onChange:e=>{v(Object.assign({},d,{alias:e}))}})]})]})]})};function Ge(e){return{inlineLabel:M.css`
      color: ${e.colors.primary.text};
    `}}const Ue=({isRaw:e,onChange:t})=>{const[a,s]=(0,R.useState)(!1);return(0,R.useEffect)((()=>{s(!1)}),[e]),e?(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)(B.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{s(!0)}}),(0,q.jsx)(B.ConfirmModal,{isOpen:a,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{t(!1)},onDismiss:()=>{s(!1)}})]}):(0,q.jsx)(B.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{t(!0)}})};var We;const He=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],Ke=e=>(0,q.jsxs)("div",{children:[We||(We=(0,q.jsx)("h2",{children:"InfluxDB Cheat Sheet"})),He.map((e=>(0,q.jsxs)("div",{className:"cheat-sheet-item",children:[(0,q.jsx)("div",{className:"cheat-sheet-item__title",children:e.title}),(0,q.jsx)("div",{className:"cheat-sheet-item__label",children:e.label})]},e.title)))]});class Je extends R.PureComponent{render(){return(0,q.jsx)(Ke,{onClickExample:this.props.onClickExample})}}var Ye,Ze,Xe,et,tt,at,st,rt;function nt(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const{Input:it,SecretFormField:ot}=B.LegacyForms,lt=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],ut=[{label:"InfluxQL",value:D.InfluxQL,description:"The InfluxDB SQL-like query language."},{label:"Flux",value:D.Flux,description:"Advanced data scripting and query language.  Supported in InfluxDB 2.x and 1.8+"}];class dt extends R.PureComponent{constructor(e){var t;super(e),nt(this,"state",{maxSeries:""}),nt(this,"htmlPrefix",void 0),nt(this,"onResetPassword",(()=>{(0,c.updateDatasourcePluginResetOption)(this.props,"password")})),nt(this,"onResetToken",(()=>{(0,c.updateDatasourcePluginResetOption)(this.props,"token")})),nt(this,"onVersionChanged",(e=>{const{options:t,onOptionsChange:a}=this.props,s=Object.assign({},t,{jsonData:Object.assign({},t.jsonData,{version:e.value})});e.value===D.Flux&&(s.access="proxy",s.basicAuth=!0,s.jsonData.httpMode="POST",delete s.user,delete s.database),a(s)})),this.state.maxSeries=(null===(t=e.options.jsonData.maxSeries)||void 0===t?void 0:t.toString())||"",this.htmlPrefix=(0,s.uniqueId)("influxdb-config")}renderInflux2x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{},{htmlPrefix:s}=this;return(0,q.jsxs)(q.Fragment,{children:[(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[(0,q.jsx)(B.InlineFormLabel,{htmlFor:`${s}-org`,className:"width-10",children:"Organization"}),(0,q.jsx)("div",{className:"width-10",children:(0,q.jsx)(it,{id:`${s}-org`,className:"width-20",value:e.jsonData.organization||"",onChange:(0,c.onUpdateDatasourceJsonDataOption)(this.props,"organization")})})]})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsx)("div",{className:"gf-form",children:(0,q.jsx)(ot,{isConfigured:t&&t.token,value:a.token||"",label:"Token","aria-label":"Token",labelWidth:10,inputWidth:20,onReset:this.onResetToken,onChange:(0,c.onUpdateDatasourceSecureJsonDataOption)(this.props,"token")})})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[Ye||(Ye=(0,q.jsx)(B.InlineFormLabel,{className:"width-10",children:"Default Bucket"})),(0,q.jsx)("div",{className:"width-10",children:(0,q.jsx)(it,{className:"width-20",placeholder:"default bucket",value:e.jsonData.defaultBucket||"",onChange:(0,c.onUpdateDatasourceJsonDataOption)(this.props,"defaultBucket")})})]})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[Ze||(Ze=(0,q.jsx)(B.InlineFormLabel,{className:"width-10",tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"})),(0,q.jsx)("div",{className:"width-10",children:(0,q.jsx)(it,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,c.onUpdateDatasourceJsonDataOption)(this.props,"timeInterval")})})]})})]})}renderInflux1x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{},{htmlPrefix:s}=this;return(0,q.jsxs)(q.Fragment,{children:[Xe||(Xe=(0,q.jsxs)(B.InfoBox,{children:[(0,q.jsx)("h5",{children:"Database Access"}),(0,q.jsxs)("p",{children:["Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",(0,q.jsx)("code",{children:"SHOW MEASUREMENTS ON _internal"})," or",(0,q.jsx)("code",{children:'SELECT * FROM "_internal".."database" LIMIT 10'}),(0,q.jsx)("br",{}),(0,q.jsx)("br",{}),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB."]})]})),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[(0,q.jsx)(B.InlineFormLabel,{htmlFor:`${s}-db`,className:"width-10",children:"Database"}),(0,q.jsx)("div",{className:"width-20",children:(0,q.jsx)(it,{id:`${s}-db`,className:"width-20",value:e.database||"",onChange:(0,c.onUpdateDatasourceOption)(this.props,"database")})})]})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[(0,q.jsx)(B.InlineFormLabel,{htmlFor:`${s}-user`,className:"width-10",children:"User"}),(0,q.jsx)("div",{className:"width-10",children:(0,q.jsx)(it,{id:`${s}-user`,className:"width-20",value:e.user||"",onChange:(0,c.onUpdateDatasourceOption)(this.props,"user")})})]})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsx)("div",{className:"gf-form",children:(0,q.jsx)(ot,{isConfigured:t&&t.password,value:a.password||"",label:"Password","aria-label":"Password",labelWidth:10,inputWidth:20,onReset:this.onResetPassword,onChange:(0,c.onUpdateDatasourceSecureJsonDataOption)(this.props,"password")})})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[(0,q.jsx)(B.InlineFormLabel,{htmlFor:`${s}-http-method`,className:"width-10",tooltip:"You can use either GET or POST HTTP method to query your InfluxDB database. The POST method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method will restrict you and return an error if the query is too large.",children:"HTTP Method"}),(0,q.jsx)(B.Select,{inputId:`${s}-http-method`,menuShouldPortal:!0,className:"width-10",value:lt.find((t=>t.value===e.jsonData.httpMode)),options:lt,defaultValue:e.jsonData.httpMode,onChange:(0,c.onUpdateDatasourceJsonDataOptionSelect)(this.props,"httpMode")})]})}),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsxs)("div",{className:"gf-form",children:[et||(et=(0,q.jsx)(B.InlineFormLabel,{className:"width-10",tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"})),(0,q.jsx)("div",{className:"width-10",children:(0,q.jsx)(it,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,c.onUpdateDatasourceJsonDataOption)(this.props,"timeInterval")})})]})})]})}render(){const{options:e,onOptionsChange:t}=this.props;return(0,q.jsxs)(q.Fragment,{children:[tt||(tt=(0,q.jsx)("h3",{className:"page-heading",children:"Query Language"})),(0,q.jsx)("div",{className:"gf-form-group",children:(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsx)("div",{className:"gf-form",children:(0,q.jsx)(B.Select,{"aria-label":"Query language",menuShouldPortal:!0,className:"width-30",value:e.jsonData.version===D.Flux?ut[1]:ut[0],options:ut,defaultValue:ut[0],onChange:this.onVersionChanged})})})}),e.jsonData.version===D.Flux&&(at||(at=(0,q.jsxs)(B.InfoBox,{children:[(0,q.jsx)("h5",{children:"Support for Flux in Grafana is currently in beta"}),(0,q.jsxs)("p",{children:["Please report any issues to: ",(0,q.jsx)("br",{}),(0,q.jsx)("a",{href:"https://github.com/grafana/grafana/issues/new/choose",children:"https://github.com/grafana/grafana/issues"})]})]}))),"direct"===e.access&&(st||(st=(0,q.jsx)(B.Alert,{title:"Deprecation Notice",severity:"warning",children:"Browser access mode in the InfluxDB datasource is deprecated and will be removed in a future release."}))),(0,q.jsx)(B.DataSourceHttpSettings,{showAccessOptions:!0,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t}),(0,q.jsxs)("div",{className:"gf-form-group",children:[rt||(rt=(0,q.jsx)("div",{children:(0,q.jsx)("h3",{className:"page-heading",children:"InfluxDB Details"})})),e.jsonData.version===D.Flux?this.renderInflux2x():this.renderInflux1x(),(0,q.jsx)("div",{className:"gf-form-inline",children:(0,q.jsx)(B.InlineField,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000.",children:(0,q.jsx)(it,{placeholder:"1000",type:"number",className:"width-10",value:this.state.maxSeries,onChange:e=>{this.setState({maxSeries:e.currentTarget.value});const t=parseInt(e.currentTarget.value,10);(0,c.updateDatasourcePluginJsonDataOption)(this.props,"maxSeries",Number.isFinite(t)?t:void 0)}})})})]})]})}}const ct=dt;var mt,pt,ht,gt;class ft extends R.PureComponent{constructor(...e){var t,a,s;super(...e),s=()=>{},(a="onRefresh")in(t=this)?Object.defineProperty(t,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[a]=s}render(){let{query:e,datasource:t,onChange:a}=this.props;return t.isFlux?(0,q.jsx)(V,{datasource:t,query:{refId:"A",query:e},onRunQuery:this.onRefresh,onChange:e=>a(e.query)}):(0,q.jsxs)("div",{className:"gf-form-inline",children:[mt||(mt=(0,q.jsx)(B.InlineFormLabel,{width:10,children:"Query"})),(0,q.jsx)("div",{className:"gf-form-inline gf-form--grow",children:(0,q.jsx)(B.TextArea,{defaultValue:e||"",placeholder:"metric name or tags query",rows:1,className:"gf-form-input",onBlur:e=>a(e.currentTarget.value)})})]})}}class yt{}gt="partials/annotations.editor.html",(ht="templateUrl")in(pt=yt)?Object.defineProperty(pt,ht,{value:gt,enumerable:!0,configurable:!0,writable:!0}):pt[ht]=gt;const vt=new c.DataSourcePlugin(H).setConfigEditor(ct).setQueryEditor((({query:e,onChange:t,onRunQuery:a,datasource:s,range:r,data:n})=>{var i;return s.isFlux?(0,q.jsx)("div",{className:"gf-form-query-content",children:(0,q.jsx)(V,{query:e,onChange:t,onRunQuery:a,datasource:s})}):(0,q.jsxs)("div",{className:(0,M.css)({display:"flex"}),children:[(0,q.jsx)("div",{className:(0,M.css)({flexGrow:1}),children:e.rawQuery?(0,q.jsx)(ee,{query:e,onChange:t,onRunQuery:a}):(0,q.jsx)(ze,{query:e,onChange:t,onRunQuery:a,datasource:s})}),(0,q.jsx)(Ue,{isRaw:null!==(i=e.rawQuery)&&void 0!==i&&i,onChange:s=>{t(Object.assign({},e,{query:$(e),rawQuery:s})),a()}})]})})).setAnnotationQueryCtrl(yt).setVariableQueryEditor(ft).setQueryEditorHelp(Je)},"./.yarn/__virtual__/react-use-virtual-ca2705900f/0/cache/react-use-npm-17.2.4-c702db5427-3c885c3798.zip/node_modules/react-use/esm/usePrevious.js":(e,t,a)=>{a.d(t,{Z:()=>r});var s=a("./.yarn/cache/react-npm-17.0.1-98658812fc-83b9df9529.zip/node_modules/react/index.js");function r(e){var t=(0,s.useRef)();return(0,s.useEffect)((function(){t.current=e})),t.current}}}]);
//# sourceMappingURL=influxdbPlugin.787ecc600122eb73aeab.js.map